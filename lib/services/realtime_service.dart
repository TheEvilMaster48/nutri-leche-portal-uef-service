import 'dart:convert';
import 'package:web_socket_channel/web_socket_channel.dart';
import 'package:web_socket_channel/status.dart' as status;

class RealtimeService {
  WebSocketChannel? _channel;

  // CONECTAR AL SERVIDOR WEBSOCKET (SPRING BOOT)
  void connect(Function(String) onMessageReceived) {
    try {
      print('‚åõ CONECTANDO AL SERVIDOR WEBSOCKET...');
      _channel = WebSocketChannel.connect(
        Uri.parse('ws://10.0.2.2:8080/ws/websocket'),
      );
      print('‚úÖ CONEXI√ìN ESTABLECIDA CON EL BACKEND');

      _channel?.stream.listen(
        (message) {
          print('üì© MENSAJE RECIBIDO: $message');
          onMessageReceived(message);
        },
        onError: (error) {
          print('‚ùå ERROR WS: $error');
        },
        onDone: () {
          print('üîå CONEXI√ìN FINALIZADA');
        },
      );
    } catch (e) {
      print('‚ö†Ô∏è ERROR AL CONECTAR: $e');
    }
  }

  // NUEVO M√âTODO COMPATIBLE CON TU C√ìDIGO
  void send(String destination, String payload) {
    if (_channel != null) {
      // AGREGAMOS DESTINO EN EL MENSAJE PARA COMPATIBILIDAD
      final data = jsonEncode({
        'destination': destination,
        'body': payload,
      });

      _channel!.sink.add(data);
      print('üì§ MENSAJE ENVIADO A $destination: $payload');
    } else {
      print('‚ö†Ô∏è NO HAY CONEXI√ìN WEBSOCKET ACTIVA');
    }
  }

  // OPCIONAL: M√âTODO DIRECTO SIN DESTINO (SI QUIERES ENVIAR SOLO TEXTO)
  void sendMessage(String message) {
    if (_channel != null) {
      _channel!.sink.add(message);
      print('üì§ MENSAJE ENVIADO: $message');
    }
  }

  // DESCONECTAR
  void disconnect() {
    _channel?.sink.close(status.goingAway);
    print('üîª CONEXI√ìN WEBSOCKET CERRADA');
  }
}
